# Project Overview

`tgbotkit-runtime` is a Go-based runtime environment designed for building Telegram bots. It provides a robust foundation for handling API interactions, event dispatching, and extensible logic via listeners and handlers, allowing developers to focus on bot logic.

## Key Features

-   **OpenAPI Client:** Utilizes the most fresh, autogenerated client (`github.com/tgbotkit/client`) derived directly from the Telegram Bot API OpenAPI specification, ensuring full API coverage, up-to-date features, and type safety.
-   **Event-Driven Architecture:** Built around a pluggable `EventEmitter` system. Listeners and handlers subscribe to events to process updates.
-   **Middleware Support:** Supports middleware for the event emitter, enabling cross-cutting concerns like context injection, logging, and recovery.
-   **Modular Design:** Core functionalities like update polling, command parsing, and message classification are implemented as distinct, reusable listeners.
-   **Flexible Configuration:** Uses the functional options pattern for type-safe and flexible configuration of the bot.
-   **Pluggable Logging:** Interfaces for logging allow for easy swapping of implementations (e.g., `slog`, `zerolog`, or no-op).

## Deployment & Development

-   **Source Control**: GitHub
-   **Language**: Go (Golang)

## Architecture

The system is orchestrated by the `Bot` struct in `bot.go`, which serves as the central point for configuration and control.

The lifecycle of the bot is as follows:

1.  **Initialization (`New`):**
    -   A `Bot` instance is created using a flexible options pattern.
    -   Essential services like the API `client`, `logger`, and `eventEmitter` are initialized with sensible defaults if not provided by the user.
    -   Core Listeners, such as the `Classifier` and `CommandParser` (from the `listeners` package), are subscribed to the event system to process incoming updates.
    -   Middleware (e.g., `ContextInjector`, `Recoverer`) is configured to wrap event processing.

2.  **Execution (`Run`):**
    -   The `Run` method starts the bot's main processing loop.
    -   It establishes an **Update Source** to receive updates from Telegram. By default, it uses a long-polling mechanism (`updatepoller`) backed by an in-memory offset store, but this can be replaced with another source, like a `webhook`.
    -   The `receiveLoop` continuously fetches updates from the source.

3.  **Event-Driven Processing:**
    -   For each update received, the `receiveLoop` emits a generic `OnUpdateReceived` event.
    -   This triggers a **Processing Pipeline** via the `EventEmitter`:
        -   **Middleware:** Wraps execution (e.g., injecting `BotContext`).
        -   **Classifier (`listeners.Classifier`):** Listens for `OnUpdateReceived`, analyzes the update content (using `messagetype`), and emits more specific events (e.g., `OnMessage`, `OnCallbackQuery`).
        -   **Command Parser (`listeners.CommandParser`):** Listens for text messages, detects commands (e.g., `/start`), and emits `OnCommand` events.
        -   **User-Defined Handlers:** Custom logic, registered via the `handlers.Registry`, subscribes to any of these events to implement the bot's features.

## Directory Structure

-   `/` - Root directory containing the main `Bot` logic and entry points.
    -   `bot.go`: Main bot initialization and run loop.
    -   `interfaces.go`: Core interfaces like `UpdateSource`.
    -   `options.gen.go`: Generated configuration options.
-   `botcontext/` - Defines `BotContext` for safe access to bot capabilities (Client, Logger, EventEmitter) within handlers.
-   `eventemitter/` - The event bus implementation. Defines `Listener`, `EventEmitter`, and `Middleware` interfaces.
-   `events/` - Definitions of event topics (strings) and payload structures.
-   `examples/` - Example bot implementations (`pingpong`, `webhook`, `command`).
-   `handlers/` - Provides a `Registry` for type-safe subscription to events (`OnUpdate`, `OnMessage`, `OnCommand`).
-   `listeners/` - Core event listeners that drive the bot's logic.
    -   `classifier.go`: Analyzes updates and emits specific events based on message type.
    -   `commandparser.go`: Parses text messages for bot commands.
-   `logger/` - Logging abstractions and adapters (`zerolog`, `slog`, `noop`).
-   `messagetype/` - Constants and helper functions for identifying Telegram message types.
-   `middleware/` - Middleware for the event emitter.
    -   `contextinjector.go`: Injects `BotContext` into the context.
    -   `logger.go`: Logs event processing.
    -   `recoverer.go`: Recovers from panics in handlers.
-   `updatepoller/` - Implements long-polling mechanism for updates.
    -   `offsetstore/`: Interfaces and implementations for storing update offsets.
-   `webhook/` - Webhook handling logic.

## Development

-   **Dependencies:**
    -   `github.com/tgbotkit/client`: The generated Telegram Bot API client.
    -   `github.com/kazhuravlev/options-gen`: Tool for generating functional options.
    -   `golangci-lint`: For code linting.
-   **Tools:**
    -   `Taskfile.yml`: Defines common development tasks.
        -   `task lint`: Runs `golangci-lint`.
        -   `task test`: Runs all tests.
        -   `task generate`: Runs code generation.
        -   `task coverage`: Calculates code coverage and shows function breakdown in console.
-   **Conventions:**
    -   Strictly follow idiomatic Go principles and best practices.
    -   Use `options-gen` for configuration structs.
    -   Use `go tool <cmd>` for executing tools defined in `go.mod`.

## Development Rules

-   **Generated Files**: Do not edit generated files directly. These files often have a comment at the top indicating they are auto-generated (e.g., `// Code generated by ... DO NOT EDIT.`). Instead, modify the source file and re-run the generator tool.
